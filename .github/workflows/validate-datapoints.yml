name: Validate SWE-bench data points

on:
  pull_request:
    paths:
      - "data_points/**"
      - ".github/workflows/validate-datapoints.yml"

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine changed data points
        id: changed
        shell: bash
        run: |
          set -euo pipefail

          BASE_REF="origin/${GITHUB_BASE_REF}"
          git fetch --no-tags origin "${GITHUB_BASE_REF}"

          # Get name-status to correctly handle renames
          RAW=$(git diff --name-status -M "$BASE_REF"...HEAD -- 'data_points/*.json')

          FILES=()

          while IFS=$'\t' read -r status src dst; do
            case "$status" in
              A|M)
                FILES+=("$src")
                ;;
              R*)
                # For renames, validate the NEW file
                FILES+=("$dst")
                ;;
            esac
          done <<< "$RAW"

          # Keep only files that still exist
          EXISTING=()
          for f in "${FILES[@]}"; do
            [ -f "$f" ] && EXISTING+=("$f")
          done

          if [ "${#EXISTING[@]}" -eq 0 ]; then
            echo "No changed data_points JSON files detected."
            echo "none=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          echo "---- EXISTING files (will validate) ----"
          printf '%s\n' "${EXISTING[@]}"
          echo "----------------------------------------"

          printf '%s\n' "${EXISTING[@]}" > /tmp/changed_files.txt

          {
            echo "files<<EOF"
            cat /tmp/changed_files.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Install uv
        if: steps.changed.outputs.none != 'true'
        run: python -m pip install --upgrade pip uv

      - name: Install dependencies
        if: steps.changed.outputs.none != 'true'
        run: uv sync --no-dev --frozen

      - name: Validate changed data points
        if: steps.changed.outputs.none != 'true'
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t FILES < <(printf '%s\n' "${{ steps.changed.outputs.files }}")
          if [ "${#FILES[@]}" -eq 0 ]; then
            echo "No changed data point files to validate."
            exit 0
          fi
          echo "Validating files:"
          printf ' - %s\n' "${FILES[@]}"
          ARGS=()
          for f in "${FILES[@]}"; do
            ARGS+=(--files "$f")
          done
          uv run python -m swe_bench_validator_custom.cli "${ARGS[@]}" --timeout 900 --max-workers 2 --run-id "ci-${{ github.run_id }}"

      - name: Summary — SWE-bench validation result
        if: always()
        shell: bash
        run: |
          {
            if [ "${{ steps.changed.outputs.none }}" = "true" ]; then
              echo "## ℹ️ SWE-bench validation"
              echo ""
              echo "No changed \`data_points/*.json\` files detected."
              echo "Validation was skipped."
              exit 0
            fi
          
            if [ "${{ job.status }}" = "success" ]; then
              echo "## ✅ SWE-bench validation passed"
              echo ""
              echo "Validated files:"
              echo ""
              while read -r f; do
                echo "- \`$f\`"
              done <<< "${{ steps.changed.outputs.files }}"
            else
              echo "## ❌ SWE-bench validation failed"
              echo ""
              echo "One or more data points did not pass validation."
              echo ""
              echo "Please check the logs above for details."
            fi
          } >> "$GITHUB_STEP_SUMMARY"
